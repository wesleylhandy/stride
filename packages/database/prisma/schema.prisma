// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // In Prisma v7, connection URLs are configured in prisma.config.ts for migrations
  // and via adapter for the Prisma Client runtime
}

enum UserRole {
  Admin
  Member
  Viewer
}

enum IssueType {
  Bug
  Feature
  Task
  Epic
}

enum Priority {
  Low
  Medium
  High
  Critical
}

enum RepositoryServiceType {
  GitHub
  GitLab
  Bitbucket
}

enum PullRequestStatus {
  Open
  Merged
  Closed
}

enum WebhookServiceType {
  Sentry
  Datadog
  NewRelic
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  role          UserRole @default(Member)
  name          String?
  avatarUrl     String?
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  reportedIssues   Issue[]                     @relation("Reporter")
  assignedIssues   Issue[]                     @relation("Assignee")
  comments         Comment[]
  attachments      Attachment[]
  sessions         Session[]
  sentInvitations  Invitation[]                @relation("SentInvitations")
  updatedConfigs   GlobalInfrastructureConfig[] @relation("ConfigUpdater")
  assistantSessions ConfigurationAssistantSession[]

  @@index([role])
  @@map("users")
}

model Project {
  id             String                 @id @default(uuid())
  key            String                 @unique
  name           String
  description    String?
  configYaml     String                 @db.Text
  config         Json                   @default("{}")
  configVersion  String?
  repositoryUrl  String?
  repositoryType RepositoryServiceType?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  // Relations
  issues                Issue[]
  cycles                Cycle[]
  repositoryConnections RepositoryConnection[]
  webhooks              Webhook[]
  aiProviderConfigs     AiProviderConfig[]
  assistantSessions     ConfigurationAssistantSession[]

  @@index([repositoryUrl])
  @@map("projects")
}

model Issue {
  id           String    @id @default(uuid())
  key          String
  projectId    String
  title        String    @db.VarChar(255)
  description  String?   @db.Text
  status       String
  type         IssueType @default(Task)
  priority     Priority?
  reporterId   String
  assigneeId   String?
  cycleId      String?
  customFields Json      @default("{}")
  storyPoints  Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  closedAt     DateTime?

  // Relations
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reporter    User          @relation("Reporter", fields: [reporterId], references: [id])
  assignee    User?         @relation("Assignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  cycle       Cycle?        @relation(fields: [cycleId], references: [id], onDelete: SetNull)
  comments    Comment[]
  attachments Attachment[]
  branches    IssueBranch[]

  @@unique([projectId, key])
  @@index([projectId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([reporterId])
  @@index([assigneeId])
  @@index([cycleId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([projectId, status])
  @@index([projectId, type])
  @@index([projectId, priority])
  @@index([projectId, updatedAt])
  @@index([customFields], type: Gin)
  @@map("issues")
}

model Cycle {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  goal        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]

  @@unique([projectId, name])
  @@index([projectId])
  @@index([startDate, endDate])
  @@map("cycles")
}

model Comment {
  id        String    @id @default(uuid())
  issueId   String
  userId    String
  content   String    @db.Text
  isSystem  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([issueId])
  @@index([userId])
  @@index([createdAt])
  @@index([issueId, createdAt])
  @@map("comments")
}

model Attachment {
  id          String   @id @default(uuid())
  issueId     String
  userId      String
  filename    String
  mimeType    String
  size        Int
  storagePath String
  createdAt   DateTime @default(now())

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([issueId])
  @@index([userId])
  @@index([issueId, createdAt])
  @@map("attachments")
}

model RepositoryConnection {
  id            String                @id @default(uuid())
  projectId     String
  repositoryUrl String                @unique
  serviceType   RepositoryServiceType
  accessToken   String // Encrypted
  webhookSecret String // Encrypted
  webhookId     String?
  isActive      Boolean               @default(true)
  lastSyncAt    DateTime?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("repository_connections")
}

model IssueBranch {
  id                String             @id @default(uuid())
  issueId           String
  branchName        String
  pullRequestUrl    String?            @unique
  pullRequestNumber Int?
  pullRequestStatus PullRequestStatus?
  lastCommitSha     String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([branchName])
  @@map("issue_branches")
}

model Webhook {
  id             String             @id @default(uuid())
  projectId      String
  serviceType    WebhookServiceType
  endpointUrl    String
  secret         String // Encrypted
  isActive       Boolean            @default(true)
  lastReceivedAt DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([serviceType])
  @@map("webhooks")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@map("sessions")
}

model Invitation {
  id         String    @id @default(uuid())
  email      String    @unique
  token      String    @unique
  role       UserRole
  invitedById String
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  invitedBy User @relation("SentInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@index([invitedById])
  @@map("invitations")
}

model GlobalInfrastructureConfig {
  id        String   @id @default(uuid())
  gitConfig Json     @default("{}")
  aiConfig  Json     @default("{}")
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  updatedByUser User? @relation("ConfigUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([updatedAt])
  @@index([updatedBy])
  @@map("global_infrastructure_config")
}

model AiProviderConfig {
  id           String   @id @default(uuid())
  projectId    String
  providerType String   // "openai", "anthropic", "ollama", etc.
  apiKey       String?  // Encrypted (for cloud providers)
  endpointUrl  String?  // Plain text (for self-hosted LLMs)
  authToken    String?  // Encrypted (optional, for self-hosted with auth)
  enabledModels Json    @default("[]") // Array of model names selected by admin
  defaultModel String?  // Default model to use if multiple enabled
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, providerType])
  @@index([projectId])
  @@map("ai_provider_configs")
}

model ConfigurationAssistantSession {
  id          String   @id @default(uuid())
  userId      String
  projectId   String?
  contextType String   // "project" or "infrastructure"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  project  Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages AssistantMessage[]

  @@index([userId, projectId])
  @@index([updatedAt])
  @@index([userId, contextType])
  @@map("configuration_assistant_sessions")
}

model AssistantMessage {
  id        String   @id @default(uuid())
  sessionId String
  role      String   // "user" or "assistant"
  content   String   @db.Text
  metadata  Json?    // Config references, doc links, suggestions
  createdAt DateTime @default(now())

  // Relations
  session ConfigurationAssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("assistant_messages")
}
