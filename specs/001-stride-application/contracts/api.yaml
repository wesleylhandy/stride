openapi: 3.0.3
info:
  title: Stride API
  version: 1.0.0
  description: Developer-first open-source flow tracker API
servers:
  - url: http://localhost:3000/api
    description: Local development
  - url: https://stride.example.com/api
    description: Production

tags:
  - name: auth
    description: Authentication and authorization
  - name: users
    description: User management
  - name: projects
    description: Project management
  - name: issues
    description: Issue management
  - name: cycles
    description: Sprint/cycle management
  - name: comments
    description: Issue comments
  - name: webhooks
    description: External service webhooks
  - name: integrations
    description: Git and monitoring integrations

paths:
  # Authentication
  /auth/login:
    post:
      tags: [auth]
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [auth]
      summary: User logout
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Logout successful

  /auth/me:
    get:
      tags: [auth]
      summary: Get current user
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # Users
  /users:
    get:
      tags: [users]
      summary: List all users (Admin only)
      description: Returns list of all users in the system. Admin access required.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [users]
      summary: Create new user (Admin only)
      description: Creates a new user account with direct password assignment. Admin access required.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, username, password, role]
              properties:
                email:
                  type: string
                  format: email
                username:
                  type: string
                  minLength: 3
                  maxLength: 50
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
                  maxLength: 100
                role:
                  type: string
                  enum: [Member, Viewer]
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/invite:
    post:
      tags: [users]
      summary: Create and send invitation (Admin only)
      description: Creates a user invitation and sends email if SMTP is configured. Returns invitation link for manual sharing if email unavailable.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, role]
              properties:
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [Member, Viewer]
      responses:
        '201':
          description: Invitation created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  invitation:
                    $ref: '#/components/schemas/Invitation'
                  inviteUrl:
                    type: string
                  emailSent:
                    type: boolean
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/invite/{token}:
    get:
      tags: [users]
      summary: Get invitation details (Public)
      description: Returns invitation details by token. Public endpoint, no authentication required.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Invitation details
          content:
            application/json:
              schema:
                type: object
                properties:
                  invitation:
                    $ref: '#/components/schemas/Invitation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          description: Invitation expired or already accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [users]
      summary: Accept invitation and create account (Public)
      description: Accepts an invitation, creates user account, and auto-logs in user. Public endpoint, no authentication required.
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 50
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
                  maxLength: 100
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '410':
          description: Invitation expired or already accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Projects
  /projects:
    get:
      tags: [projects]
      summary: List projects
      security:
        - cookieAuth: []
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'

    post:
      tags: [projects]
      summary: Create project
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [key, name]
              properties:
                key:
                  type: string
                  pattern: '^[A-Z0-9]{2,10}$'
                name:
                  type: string
                description:
                  type: string
                repositoryUrl:
                  type: string
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Project'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /projects/{projectId}:
    get:
      tags: [projects]
      summary: Get project
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [projects]
      summary: Update project
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: Project updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Project'
        '403':
          $ref: '#/components/responses/Forbidden'

  /projects/{projectId}/config:
    get:
      tags: [projects]
      summary: Get project configuration (YAML)
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Configuration YAML
          content:
            text/yaml:
              schema:
                type: string
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      tags: [projects]
      summary: Update project configuration
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          text/yaml:
            schema:
              type: string
      responses:
        '200':
          description: Configuration updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Project'
                  validation:
                    type: object
                    properties:
                      valid:
                        type: boolean
                      errors:
                        type: array
                        items:
                          type: object
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  # Issues
  /projects/{projectId}/issues:
    get:
      tags: [issues]
      summary: List issues
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: status
          in: query
          schema:
            type: string
        - name: assigneeId
          in: query
          schema:
            type: string
            format: uuid
        - name: cycleId
          in: query
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: List of issues
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Issue'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags: [issues]
      summary: Create issue
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title:
                  type: string
                  maxLength: 255
                description:
                  type: string
                status:
                  type: string
                type:
                  type: string
                  enum: [Bug, Feature, Task, Epic]
                priority:
                  type: string
                  enum: [Low, Medium, High, Critical]
                assigneeId:
                  type: string
                  format: uuid
                cycleId:
                  type: string
                  format: uuid
                storyPoints:
                  type: integer
                  minimum: 1
                customFields:
                  type: object
      responses:
        '201':
          description: Issue created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Issue'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /projects/{projectId}/issues/{issueKey}:
    get:
      tags: [issues]
      summary: Get issue
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: issueKey
          in: path
          required: true
          schema:
            type: string
            pattern: '^[A-Z0-9]+-[0-9]+$'
      responses:
        '200':
          description: Issue details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Issue'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [issues]
      summary: Update issue
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: issueKey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                status:
                  type: string
                assigneeId:
                  type: string
                  format: uuid
                cycleId:
                  type: string
                  format: uuid
                storyPoints:
                  type: integer
                customFields:
                  type: object
      responses:
        '200':
          description: Issue updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Issue'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /projects/{projectId}/issues/{issueKey}/status:
    patch:
      tags: [issues]
      summary: Update issue status
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: issueKey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Issue'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  # Cycles
  /projects/{projectId}/cycles:
    get:
      tags: [cycles]
      summary: List cycles
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: List of cycles
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Cycle'

    post:
      tags: [cycles]
      summary: Create cycle
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, startDate, endDate]
              properties:
                name:
                  type: string
                description:
                  type: string
                startDate:
                  type: string
                  format: date
                endDate:
                  type: string
                  format: date
                goal:
                  type: string
      responses:
        '201':
          description: Cycle created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Cycle'
        '400':
          $ref: '#/components/responses/BadRequest'

  /projects/{projectId}/cycles/{cycleId}:
    get:
      tags: [cycles]
      summary: Get cycle with metrics
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: cycleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cycle details with metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Cycle'
                  metrics:
                    $ref: '#/components/schemas/CycleMetrics'

  # Comments
  /projects/{projectId}/issues/{issueKey}/comments:
    get:
      tags: [comments]
      summary: List issue comments
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: issueKey
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Comment'

    post:
      tags: [comments]
      summary: Create comment
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: issueKey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Comment'

  # Webhooks
  /webhooks/github:
    post:
      tags: [webhooks]
      summary: GitHub webhook endpoint
      parameters:
        - name: X-Hub-Signature-256
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /webhooks/gitlab:
    post:
      tags: [webhooks]
      summary: GitLab webhook endpoint
      parameters:
        - name: X-Gitlab-Token
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed

  /webhooks/sentry:
    post:
      tags: [webhooks]
      summary: Sentry webhook endpoint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed

  # Integrations
  /api/preview-link:
    post:
      tags: [integrations]
      summary: Preview external link
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Link preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/LinkPreview'
        '400':
          $ref: '#/components/responses/BadRequest'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session

  parameters:
    ProjectId:
      name: projectId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        username:
          type: string
        name:
          type: string
        role:
          type: string
          enum: [Admin, Member, Viewer]
        avatarUrl:
          type: string
          format: uri
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Invitation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [Admin, Member, Viewer]
        expiresAt:
          type: string
          format: date-time
        invitedBy:
          type: string
          nullable: true

    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key:
          type: string
        name:
          type: string
        description:
          type: string
        repositoryUrl:
          type: string
          format: uri
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Issue:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key:
          type: string
        title:
          type: string
        description:
          type: string
        status:
          type: string
        type:
          type: string
          enum: [Bug, Feature, Task, Epic]
        priority:
          type: string
          enum: [Low, Medium, High, Critical]
        reporter:
          $ref: '#/components/schemas/User'
        assignee:
          $ref: '#/components/schemas/User'
        cycle:
          $ref: '#/components/schemas/Cycle'
        customFields:
          type: object
        storyPoints:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Cycle:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        goal:
          type: string
        createdAt:
          type: string
          format: date-time

    CycleMetrics:
      type: object
      properties:
        totalStoryPoints:
          type: integer
        completedStoryPoints:
          type: integer
        remainingStoryPoints:
          type: integer
        averageCycleTime:
          type: number
        burndownData:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              remaining:
                type: integer

    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        user:
          $ref: '#/components/schemas/User'
        isSystem:
          type: boolean
        createdAt:
          type: string
          format: date-time

    LinkPreview:
      type: object
      properties:
        url:
          type: string
          format: uri
        title:
          type: string
        description:
          type: string
        thumbnail:
          type: string
          format: uri
        siteName:
          type: string

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
                  details:
                    type: array
                    items:
                      type: object

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string

    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string

